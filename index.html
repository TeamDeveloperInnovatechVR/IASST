<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chat con IASST — Ambiente Consultores</title>
  <style>
    :root {
      --deep:#1e2146;
      --accent:#f28a1a;
      --light:#f5f5f7;
      --gray:#bbb;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    * {box-sizing:border-box;margin:0;padding:0}
    body {
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      background:linear-gradient(135deg, var(--deep) 0%, #141630 100%);
      color:#fff;
      padding:20px;
    }
    .app {
      display:flex;
      flex-direction:column;
      width:100%;
      max-width:950px;
      background:rgba(30,33,70,0.97);
      border-radius:20px;
      box-shadow:0 12px 40px rgba(0,0,0,0.6);
      overflow:hidden;
      animation:fadeIn 0.6s ease;
    }
    @keyframes fadeIn {from{opacity:0; transform:scale(0.95)} to{opacity:1; transform:scale(1)}}

    /* Header */
    .header {
      display:flex;align-items:center;justify-content:space-between;
      padding:16px 24px;background:rgba(255,255,255,0.05);backdrop-filter:blur(8px);
    }
    .header-left{display:flex;align-items:center;gap:14px;}
    .header-logo{width:46px;height:46px;border-radius:50%;overflow:hidden;background:#fff;box-shadow:0 0 12px rgba(242,138,26,0.6)}
    .header-logo img{width:100%;height:100%;object-fit:contain}
    .header-title{font-size:18px;font-weight:bold;color:var(--accent)}
    .header-sub{font-size:12px;color:var(--gray)}
    .header-bot{width:54px;height:54px;border-radius:50%;overflow:hidden;background:#fff;box-shadow:0 0 12px rgba(255,255,255,0.2)}
    .header-bot img{width:100%;height:100%;object-fit:cover}

    /* Chat */
    .chat-area{flex:1;display:flex;flex-direction:column;}
    .messages{
      flex:1;padding:20px;overflow-y:auto;
      display:flex;flex-direction:column;gap:12px;
      background:rgba(255,255,255,0.01);
      scroll-behavior:smooth;
    }
    .msg{
      max-width:75%;padding:12px 16px;border-radius:16px;
      font-size:14px;line-height:1.4;animation:slideIn 0.3s ease;
    }
    .bot{
      align-self:flex-start;
      background:rgba(255,255,255,0.1);
      backdrop-filter:blur(4px);
      box-shadow:0 4px 12px rgba(0,0,0,0.4);
    }
    .user{
      align-self:flex-end;
      background:linear-gradient(135deg,var(--accent),#ffb165);
      color:var(--deep);font-weight:500;
      box-shadow:0 4px 12px rgba(0,0,0,0.5);
    }
    @keyframes slideIn{from{opacity:0; transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}

    .typing{display:flex;align-items:center;gap:6px;font-size:13px;color:#ccc;}
    .dot{width:6px;height:6px;background:#ccc;border-radius:50%;animation:bounce 1s infinite;}
    .dot:nth-child(2){animation-delay:0.2s;}
    .dot:nth-child(3){animation-delay:0.4s;}
    @keyframes bounce{0%,80%,100%{transform:scale(0.6);}40%{transform:scale(1);} }

    .composer{display:flex;gap:10px;padding:14px;background:rgba(255,255,255,0.05);}
    .composer input{
      flex:1;padding:12px;border-radius:10px;border:none;font-size:14px;
      background:rgba(255,255,255,0.1);color:#fff;
    }
    .composer input::placeholder{color:#bbb}
    .composer button{
      background:var(--accent);border:none;color:var(--deep);
      padding:12px 20px;border-radius:10px;font-weight:bold;cursor:pointer;
      transition:0.2s;
    }
    .composer button:hover{opacity:0.9;transform:scale(1.05)}
    .composer button:disabled{background:gray;cursor:not-allowed;transform:none;}

    #statusText{padding:8px;text-align:center;font-size:13px;color:#ccc;
      background:rgba(255,255,255,0.03);border-top:1px solid rgba(255,255,255,0.1)
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="header">
      <div class="header-left">
        <div class="header-logo"><img src="AMB.png" alt="Logo Ambiente Consultores"></div>
        <div>
          <div class="header-title">Chat con IASST</div>
          <div class="header-sub">Asistente virtual de Ambiente Consultores</div>
        </div>
      </div>
      <div class="header-bot"><img src="robot.png" alt="Avatar IASST"></div>
    </div>

    <div class="chat-area">
      <div class="messages" id="messages">
        <div class="msg bot">👋 Hola, soy IASST. ¿En qué te puedo ayudar hoy?</div>
      </div>
      <div class="composer">
        <input id="input" placeholder="Escribe tu mensaje..." disabled />
        <button id="send" disabled>Enviar</button>
      </div>
      <div id="statusText">🔄 Cargando configuración...</div>
    </div>
  </div>

<script>
const FIREBASE_URL = "https://iasst-b2ab0-default-rtdb.firebaseio.com/.json";
let API_KEY=null, ASSISTANT_ID=null, currentThreadId=null, isWaiting=false;

const sendBtn=document.getElementById('send');
const input=document.getElementById('input');
const messages=document.getElementById('messages');
const statusText=document.getElementById('statusText');

function appendMessage(text,type){
  const div=document.createElement('div');
  div.className='msg '+type;
  div.textContent=text;
  messages.appendChild(div);
  messages.scrollTop=messages.scrollHeight;
}
function showTyping(){
  const div=document.createElement('div');
  div.className='msg bot typing';
  div.innerHTML=`<span class="dot"></span><span class="dot"></span><span class="dot"></span>`;
  div.id="typing-indicator";
  messages.appendChild(div);
  messages.scrollTop=messages.scrollHeight;
}
function hideTyping(){
  const el=document.getElementById("typing-indicator");
  if(el) el.remove();
}
async function loadFirebaseKeys(){
  try{
    const res=await fetch(FIREBASE_URL);
    const data=await res.json();
    API_KEY=data.KeyChatGPT; ASSISTANT_ID=data.KeyAssit;
    statusText.textContent="✅ Configuración lista. Pregunta lo que quieras.";
    input.disabled=false; sendBtn.disabled=false;
  }catch(e){statusText.textContent="❌ Error al cargar configuración";}
}
async function createThread(){
  const res=await fetch("https://api.openai.com/v1/threads",{
    method:"POST",
    headers:{"Authorization":"Bearer "+API_KEY,"Content-Type":"application/json","OpenAI-Beta":"assistants=v2"},
    body:"{}"
  });
  const data=await res.json(); currentThreadId=data.id;
}
async function askAssistant(question){
  try{
    if(!currentThreadId) await createThread();
    isWaiting=true; input.disabled=true; sendBtn.disabled=true;
    statusText.textContent="⏳ Preguntando a IASST...";
    appendMessage(question,'user');

    // user msg
    await fetch(`https://api.openai.com/v1/threads/${currentThreadId}/messages`,{
      method:"POST",
      headers:{"Authorization":"Bearer "+API_KEY,"Content-Type":"application/json","OpenAI-Beta":"assistants=v2"},
      body:JSON.stringify({role:"user",content:[{type:"text",text:question}]})
    });

    // run
    const runRes=await fetch(`https://api.openai.com/v1/threads/${currentThreadId}/runs`,{
      method:"POST",
      headers:{"Authorization":"Bearer "+API_KEY,"Content-Type":"application/json","OpenAI-Beta":"assistants=v2"},
      body:JSON.stringify({assistant_id:ASSISTANT_ID})
    });
    const runData=await runRes.json();
    const runId=runData.id;

    showTyping();
    let completed=false;
    while(!completed){
      const statusRes=await fetch(`https://api.openai.com/v1/threads/${currentThreadId}/runs/${runId}`,{
        headers:{"Authorization":"Bearer "+API_KEY,"OpenAI-Beta":"assistants=v2"}
      });
      const st=await statusRes.json();
      if(st.status==="completed"){completed=true;}
      else if(st.status==="failed"){hideTyping();appendMessage("⚠️ Error procesando.","bot");return;}
      else{
        statusText.textContent= st.status==="in_progress"?"🤖 Analizando...":"📝 Redactando respuesta...";
        await new Promise(r=>setTimeout(r,1200));
      }
    }

    hideTyping();
    statusText.textContent="✅ Respuesta recibida.";
    const poll=await fetch(`https://api.openai.com/v1/threads/${currentThreadId}/messages`,{
      headers:{"Authorization":"Bearer "+API_KEY,"OpenAI-Beta":"assistants=v2"}
    });
    const pollData=await poll.json();
    const msg=pollData.data.find(d=>d.role==="assistant"&&d.content?.length>0);
    if(msg) appendMessage(msg.content[0].text.value,"bot");
  }catch(err){appendMessage("⚠️ Error al comunicar con IASST","bot");}
  finally{
    isWaiting=false; input.disabled=false; sendBtn.disabled=false;
    statusText.textContent="💬 Puedes seguir preguntando.";
  }
}
sendBtn.addEventListener('click',()=>{if(input.value.trim()) askAssistant(input.value.trim()),input.value='';});
input.addEventListener('keypress',e=>{if(e.key==="Enter"&&!sendBtn.disabled) sendBtn.click();});
loadFirebaseKeys();
</script>
</body>
</html>
