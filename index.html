<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chat con IASST â€” Ambiente Consultores</title>
  <style>
    :root {
      --deep:#1e2146;
      --accent:#f28a1a;
      --light:#f5f5f7;
      --gray:#bbb;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    body {
      min-height:100vh;display:flex;align-items:center;justify-content:center;
      background:linear-gradient(135deg, var(--deep) 0%, #141630 100%);
      color:#fff;padding:20px;
    }
    .app {display:flex;flex-direction:column;width:100%;max-width:950px;
      background:rgba(30,33,70,0.97);border-radius:20px;box-shadow:0 12px 40px rgba(0,0,0,0.6);overflow:hidden;
    }

    /* Header */
    .header {display:flex;align-items:center;justify-content:space-between;
      padding:16px 24px;background:rgba(255,255,255,0.05);backdrop-filter:blur(8px);}
    .header-left{display:flex;align-items:center;gap:14px;}
    .header-logo{width:46px;height:46px;border-radius:50%;overflow:hidden;background:#fff;}
    .header-logo img{width:100%;height:100%;object-fit:contain}
    .header-title{font-size:18px;font-weight:bold;color:var(--accent)}
    .header-sub{font-size:12px;color:var(--gray)}

    /* Toggle */
    .toggle-container{display:flex;align-items:center;gap:10px;color:#fff;font-size:13px;}
    .toggle-container input{width:40px;height:20px;}

    /* Chat */
    .chat-area{flex:1;display:flex;flex-direction:column;}
    .messages{flex:1;padding:20px;overflow-y:auto;display:flex;flex-direction:column;gap:12px;}
    .msg{max-width:75%;padding:12px 16px;border-radius:16px;font-size:14px;line-height:1.4;}
    .bot{align-self:flex-start;background:rgba(255,255,255,0.1);}
    .user{align-self:flex-end;background:linear-gradient(135deg,var(--accent),#ffb165);color:var(--deep);font-weight:500;}

    .composer{display:flex;gap:10px;padding:14px;background:rgba(255,255,255,0.05);}
    .composer input{flex:1;padding:12px;border-radius:10px;border:none;font-size:14px;background:rgba(255,255,255,0.1);color:#fff;}
    .composer button{background:var(--accent);border:none;color:var(--deep);padding:12px 20px;border-radius:10px;font-weight:bold;cursor:pointer;}

    /* Documento */
    .doc-uploader{display:none;flex-direction:column;gap:12px;padding:14px;background:rgba(255,255,255,0.05);}
    .doc-section{display:flex;gap:10px;align-items:center;}
    .progress-bar{width:100%;height:14px;background:#333;border-radius:7px;overflow:hidden;}
    .progress{height:100%;width:0;background:var(--accent);transition:width 0.3s;}
    .doc-controls{display:flex;flex-direction:column;gap:10px;} /* habilitado por defecto */
    .doc-controls input{padding:12px;border-radius:10px;border:none;font-size:14px;background:#fff;color:#000;}
    .doc-controls button{background:var(--accent);border:none;color:var(--deep);padding:12px 20px;border-radius:10px;font-weight:bold;cursor:pointer;}
    #statusText{padding:8px;text-align:center;font-size:13px;color:#ccc;}
  </style>
</head>
<body>
  <div class="app">
    <div class="header">
      <div class="header-left">
        <div class="header-logo"><img src="AMB.png" alt="Logo"></div>
        <div>
          <div class="header-title">Chat con IASST</div>
          <div class="header-sub">Asistente virtual de Ambiente Consultores</div>
        </div>
      </div>
      <div class="toggle-container">
        <label>ChatGPT Directo</label>
        <input type="checkbox" id="modeToggle" checked />
      </div>
    </div>

    <div class="chat-area">
      <div class="messages" id="messages">
        <div class="msg bot">ðŸ‘‹ Hola, soy IASST. Â¿En quÃ© te puedo ayudar hoy?</div>
      </div>

      <!-- Input normal -->
      <div class="composer" id="chatComposer">
        <input id="input" placeholder="Escribe tu mensaje..." disabled />
        <button id="send" disabled>Enviar</button>
      </div>

      <!-- Subida de documentos -->
      <div class="doc-uploader" id="docUploader">
        <div class="doc-section">
          <input type="file" id="fileInput" />
          <button id="uploadBtn">Subir Documento</button>
        </div>
        <div class="progress-bar"><div class="progress" id="progress"></div></div>

        <div class="doc-controls" id="docControls">
          <button id="uploadMore">âž• Subir otro documento</button>
          <input id="docQuestion" placeholder="Haz una pregunta..." />
          <button id="askDocBtn">Preguntar</button>
        </div>
      </div>

      <div id="statusText">ðŸ”„ Cargando configuraciÃ³n...</div>
    </div>
  </div>

<script>
const FIREBASE_URL="https://iasst-b2ab0-default-rtdb.firebaseio.com/.json";
let API_KEY=null,ASSISTANT_ID=null,currentThreadId=null,isWaiting=false;

// refs
const toggle=document.getElementById('modeToggle');
const chatComposer=document.getElementById('chatComposer');
const docUploader=document.getElementById('docUploader');
const progressBar=document.getElementById('progress');
const messages=document.getElementById('messages');
const sendBtn=document.getElementById('send');
const input=document.getElementById('input');
const statusText=document.getElementById('statusText');

// helper para mensajes en pantalla
function appendMessage(text,type){
  const div=document.createElement('div');
  div.className='msg '+type;
  div.textContent=text;
  messages.appendChild(div);
  messages.scrollTop=messages.scrollHeight;
}

// =========================
// LOAD CONFIG FROM FIREBASE
// =========================
async function loadFirebaseKeys(){
  try{
    const res=await fetch(FIREBASE_URL);
    const data=await res.json();
    API_KEY=data.KeyChatGPT;
    ASSISTANT_ID=data.KeyAssit;
    statusText.textContent="âœ… ConfiguraciÃ³n lista. Pregunta lo que quieras.";
    input.disabled=false; sendBtn.disabled=false;
    console.log("âš™ï¸ ConfiguraciÃ³n cargada:",data);
  }catch(e){
    statusText.textContent="âŒ Error al cargar configuraciÃ³n";
    console.error("âŒ Error al cargar Firebase:",e);
  }
}

// =========================
// THREAD
// =========================
async function createThread(){
  console.log("ðŸ§µ Creando nuevo thread...");
  const res=await fetch("https://api.openai.com/v1/threads",{
    method:"POST",
    headers:{
      "Authorization":"Bearer "+API_KEY,
      "Content-Type":"application/json",
      "OpenAI-Beta":"assistants=v2"
    },
    body:"{}"
  });
  const data=await res.json();
  currentThreadId=data.id;
  console.log("âœ… Thread creado:",currentThreadId);
}

// =========================
// ASK ASSISTANT (GENERAL)
// =========================
async function askAssistant(question){
  try{
    if(!currentThreadId) await createThread();
    isWaiting=true;
    input.disabled=true; sendBtn.disabled=true;
    statusText.textContent="â³ Preguntando a IASST...";
    appendMessage(question,'user');
    console.log("ðŸ“¤ Enviando pregunta:",question);

    // enviar mensaje
    await fetch(`https://api.openai.com/v1/threads/${currentThreadId}/messages`,{
      method:"POST",
      headers:{
        "Authorization":"Bearer "+API_KEY,
        "Content-Type":"application/json",
        "OpenAI-Beta":"assistants=v2"
      },
      body:JSON.stringify({role:"user",content:[{type:"text",text:question}]})
    });
    console.log("âœ… Mensaje enviado al thread");

    // crear run
    const runRes=await fetch(`https://api.openai.com/v1/threads/${currentThreadId}/runs`,{
      method:"POST",
      headers:{
        "Authorization":"Bearer "+API_KEY,
        "Content-Type":"application/json",
        "OpenAI-Beta":"assistants=v2"
      },
      body:JSON.stringify({assistant_id:ASSISTANT_ID})
    });
    const runData=await runRes.json();
    const runId=runData.id;
    console.log("ðŸš€ Run lanzado:",runId);

    let completed=false, step=0;
    while(!completed){
      const statusRes=await fetch(`https://api.openai.com/v1/threads/${currentThreadId}/runs/${runId}`,{
        headers:{
          "Authorization":"Bearer "+API_KEY,
          "OpenAI-Beta":"assistants=v2"
        }
      });
      const st=await statusRes.json();
      console.log(`ðŸ” Estado del run (${step++}):`,st.status);

      if(st.status==="completed"){completed=true;}
      else if(st.status==="failed"){appendMessage("âš ï¸ Error procesando.","bot");return;}
      else{
        statusText.textContent= st.status==="in_progress"?"ðŸ¤– Analizando...":"ðŸ“ Redactando respuesta...";
        appendMessage("â³ (Debug) TodavÃ­a pensando...","bot");
        await new Promise(r=>setTimeout(r,1500));
      }
    }

    statusText.textContent="âœ… Respuesta recibida.";
    const poll=await fetch(`https://api.openai.com/v1/threads/${currentThreadId}/messages`,{
      headers:{
        "Authorization":"Bearer "+API_KEY,
        "OpenAI-Beta":"assistants=v2"
      }
    });
    const pollData=await poll.json();
    const msg=pollData.data.find(d=>d.role==="assistant"&&d.content?.length>0);
    if(msg) appendMessage(msg.content[0].text.value,"bot");
    console.log("ðŸ“¥ Respuesta recibida:",msg?.content[0]?.text?.value);
  }catch(err){
    appendMessage("âš ï¸ Error al comunicar con IASST","bot");
    console.error("âŒ Error en askAssistant:",err);
  }finally{
    isWaiting=false;
    input.disabled=false; sendBtn.disabled=false;
    statusText.textContent="ðŸ’¬ Puedes seguir preguntando.";
  }
}

// =========================
// EVENTOS CHAT
// =========================
sendBtn.addEventListener('click',()=>{if(input.value.trim()) askAssistant(input.value.trim()),input.value='';});
input.addEventListener('keypress',e=>{if(e.key==="Enter"&&!sendBtn.disabled) sendBtn.click();});

// =========================
// TOGGLE ENTRE MODOS
// =========================
toggle.addEventListener('change',()=>{
  if(toggle.checked){ chatComposer.style.display="flex"; docUploader.style.display="none";}
  else{ chatComposer.style.display="none"; docUploader.style.display="flex";}
});

// =========================
// SUBIR DOCUMENTO CON PROGRESO
// =========================
document.getElementById("uploadBtn").addEventListener("click",()=>{
  const file=document.getElementById("fileInput").files[0];
  if(!file) return alert("Selecciona un documento primero");

  console.log("ðŸ“‚ Subiendo documento:",file.name);
  const xhr=new XMLHttpRequest();
  const formData=new FormData();
  formData.append("file",file);
  formData.append("purpose","assistants");

  xhr.open("POST","https://api.openai.com/v1/files");
  xhr.setRequestHeader("Authorization","Bearer "+API_KEY);

  xhr.upload.onprogress=(e)=>{
    if(e.lengthComputable){
      const percent=Math.round((e.loaded/e.total)*100);
      progressBar.style.width=percent+"%";
      statusText.textContent=`ðŸ“¤ Subiendo... ${percent}%`;
    }
  };

  xhr.onload=()=>{
    if(xhr.status===200){
      progressBar.style.width="100%";
      appendMessage("âœ… Documento subido correctamente","bot");
      statusText.textContent="ðŸ“„ Documento listo para consultas.";
      console.log("âœ… Documento subido con Ã©xito");
    }else{
      appendMessage("âŒ Error al subir documento","bot");
      console.error("âŒ Error al subir documento:",xhr.responseText);
    }
  };

  xhr.send(formData);
});

// subir mÃ¡s documentos
document.getElementById("uploadMore").addEventListener("click",()=>{
  progressBar.style.width="0";
  document.getElementById("fileInput").value="";
  statusText.textContent="âž• Puedes subir otro documento o preguntar sin subir.";
});

// preguntar (sin importar si hay doc)
document.getElementById("askDocBtn").addEventListener("click",()=>{
  const q=document.getElementById("docQuestion").value.trim();
  if(!q) return;
  askAssistant(q);
  document.getElementById("docQuestion").value="";
});

// =========================
// START
// =========================
loadFirebaseKeys();
</script>
</body>
</html>
