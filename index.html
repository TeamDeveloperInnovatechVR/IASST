<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chat con IASST ‚Äî Ambiente Consultores</title>
  <style>
    :root {
      --deep:#1e2146;
      --accent:#f28a1a;
      --light:#f5f5f7;
      --gray:#bbb;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    body {
      min-height:100vh;display:flex;align-items:center;justify-content:center;
      background:linear-gradient(135deg, var(--deep) 0%, #141630 100%);
      color:#fff;padding:20px;
    }
    .app {display:flex;flex-direction:column;width:100%;max-width:950px;
      background:rgba(30,33,70,0.97);border-radius:20px;box-shadow:0 12px 40px rgba(0,0,0,0.6);overflow:hidden;
    }

    /* Header */
    .header {display:flex;align-items:center;justify-content:space-between;
      padding:16px 24px;background:rgba(255,255,255,0.05);backdrop-filter:blur(8px);}
    .header-left{display:flex;align-items:center;gap:14px;}
    .header-logo{width:46px;height:46px;border-radius:50%;overflow:hidden;background:#fff;}
    .header-logo img{width:100%;height:100%;object-fit:contain}
    .header-title{font-size:18px;font-weight:bold;color:var(--accent)}
    .header-sub{font-size:12px;color:var(--gray)}

    /* Toggle */
    .toggle-container{display:flex;align-items:center;gap:10px;color:#fff;font-size:13px;}
    .toggle-container input{width:40px;height:20px;}

    /* Chat */
    .chat-area{flex:1;display:flex;flex-direction:column;}
    .messages{flex:1;padding:20px;overflow-y:auto;display:flex;flex-direction:column;gap:12px;}
    .msg{max-width:75%;padding:12px 16px;border-radius:16px;font-size:14px;line-height:1.4;}
    .bot{align-self:flex-start;background:rgba(255,255,255,0.1);}
    .user{align-self:flex-end;background:linear-gradient(135deg,var(--accent),#ffb165);color:var(--deep);font-weight:500;}

    .composer{display:flex;gap:10px;padding:14px;background:rgba(255,255,255,0.05);}
    .composer input{flex:1;padding:12px;border-radius:10px;border:none;font-size:14px;background:rgba(255,255,255,0.1);color:#fff;}
    .composer button{background:var(--accent);border:none;color:var(--deep);padding:12px 20px;border-radius:10px;font-weight:bold;cursor:pointer;}

    /* Documento */
    .doc-uploader{display:none;flex-direction:column;gap:12px;padding:14px;background:rgba(255,255,255,0.05);}
    .doc-section{display:flex;gap:10px;align-items:center;}
    .progress-bar{width:100%;height:14px;background:#333;border-radius:7px;overflow:hidden;}
    .progress{height:100%;width:0;background:var(--accent);transition:width 0.3s;}
    .doc-controls{display:flex;flex-direction:column;gap:10px;}
    .doc-controls input{padding:12px;border-radius:10px;border:none;font-size:14px;background:#fff;color:#000;}
    .doc-controls button{background:var(--accent);border:none;color:var(--deep);padding:12px 20px;border-radius:10px;font-weight:bold;cursor:pointer;}
    #statusText{padding:8px;text-align:center;font-size:13px;color:#ccc;}
  </style>
</head>
<body>
  <div class="app">
    <div class="header">
      <div class="header-left">
        <div class="header-logo"><img src="AMB.png" alt="Logo"></div>
        <div>
          <div class="header-title">Chat con IASST</div>
          <div class="header-sub">Asistente virtual de Ambiente Consultores</div>
        </div>
      </div>
      <div class="toggle-container">
        <label>ChatGPT Directo</label>
        <input type="checkbox" id="modeToggle" checked />
      </div>
    </div>

    <div class="chat-area">
      <div class="messages" id="messages">
        <div class="msg bot">üëã Hola, soy IASST. ¬øEn qu√© te puedo ayudar hoy?</div>
      </div>

      <!-- Input normal -->
      <div class="composer" id="chatComposer">
        <input id="input" placeholder="Escribe tu mensaje..." disabled />
        <button id="send" disabled>Enviar</button>
      </div>

      <!-- Subida de documentos -->
      <div class="doc-uploader" id="docUploader">
        <div class="doc-section">
          <input type="file" id="fileInput" />
          <button id="uploadBtn">Subir Documento</button>
        </div>
        <div class="progress-bar"><div class="progress" id="progress"></div></div>

        <div class="doc-controls" id="docControls">
          <button id="uploadMore">‚ûï Subir otro documento</button>
          <input id="docQuestion" placeholder="Haz una pregunta..." />
          <button id="askDocBtn">Preguntar</button>
        </div>
      </div>

      <div id="statusText">üîÑ Cargando configuraci√≥n...</div>
    </div>
  </div>

<script>
const FIREBASE_URL="https://iasst-b2ab0-default-rtdb.firebaseio.com/.json";
let API_KEY=null,ASSISTANT_ID=null,currentThreadId=null,isWaiting=false;

// refs
const toggle=document.getElementById('modeToggle');
const chatComposer=document.getElementById('chatComposer');
const docUploader=document.getElementById('docUploader');
const progressBar=document.getElementById('progress');
const messages=document.getElementById('messages');
const sendBtn=document.getElementById('send');
const input=document.getElementById('input');
const statusText=document.getElementById('statusText');

// helper para mensajes en pantalla (solo mensajes reales, no debug)
function appendMessage(text,type){
  const div=document.createElement('div');
  div.className='msg '+type;
  div.textContent=text;
  messages.appendChild(div);
  messages.scrollTop=messages.scrollHeight;
}

// =========================
// LOAD CONFIG FROM FIREBASE
// =========================
async function loadFirebaseKeys(){
  try{
    const res=await fetch(FIREBASE_URL);
    const data=await res.json();
    API_KEY=data.KeyChatGPT;
    ASSISTANT_ID=data.KeyAssit;
    statusText.textContent="‚úÖ Configuraci√≥n lista. Pregunta lo que quieras.";
    input.disabled=false; sendBtn.disabled=false;
    console.log("‚öôÔ∏è Configuraci√≥n cargada:",data);
  }catch(e){
    statusText.textContent="‚ùå Error al cargar configuraci√≥n";
    console.error("‚ùå Error al cargar Firebase:",e);
  }
}

// =========================
// THREAD
// =========================
async function createThread(){
  console.log("üßµ Creando nuevo thread...");
  const res=await fetch("https://api.openai.com/v1/threads",{
    method:"POST",
    headers:{
      "Authorization":"Bearer "+API_KEY,
      "Content-Type":"application/json",
      "OpenAI-Beta":"assistants=v2"
    },
    body:"{}"
  });
  const data=await res.json();
  currentThreadId=data.id;
  console.log("‚úÖ Thread creado:",currentThreadId);
}

// =========================
// ASK ASSISTANT (GENERAL)
// =========================
async function askAssistant(question){
  // helpers locales para animaciones/tiempos
  function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
  let dotIntervalId = null;
  function clearDots(){ if(dotIntervalId){ clearInterval(dotIntervalId); dotIntervalId=null; } }

  async function typeStatusText(text, speed=20){
    // Si el texto actual es exactamente igual, no volver a teclear
    if(statusText._lastTyped === text) return;
    clearDots();
    statusText._lastTyped = text;
    statusText.textContent = "";
    for(let i=0;i<=text.length;i++){
      statusText.textContent = text.slice(0,i);
      await sleep(speed);
    }
  }

  function startDotAnimation(baseText, interval=500){
    clearDots();
    let dots = "";
    dotIntervalId = setInterval(()=>{
      dots = (dots.length >= 3) ? "" : dots + ".";
      statusText.textContent = baseText + dots;
    }, interval);
  }

  try{
    if(!currentThreadId) await createThread();
    isWaiting=true;
    input.disabled=true; sendBtn.disabled=true;
    statusText.textContent="‚è≥ Preguntando a IASST...";
    appendMessage(question,'user');
    console.log("üì§ Enviando pregunta:",question);

    // enviar mensaje
    await fetch(`https://api.openai.com/v1/threads/${currentThreadId}/messages`,{
      method:"POST",
      headers:{
        "Authorization":"Bearer "+API_KEY,
        "Content-Type":"application/json",
        "OpenAI-Beta":"assistants=v2"
      },
      body:JSON.stringify({role:"user",content:[{type:"text",text:question}]})
    });
    console.log("‚úÖ Mensaje enviado al thread");

    // crear run
    const runRes=await fetch(`https://api.openai.com/v1/threads/${currentThreadId}/runs`,{
      method:"POST",
      headers:{
        "Authorization":"Bearer "+API_KEY,
        "Content-Type":"application/json",
        "OpenAI-Beta":"assistants=v2"
      },
      body:JSON.stringify({assistant_id:ASSISTANT_ID})
    });
    const runData=await runRes.json();
    const runId=runData.id;
    console.log("üöÄ Run lanzado:",runId);

    // SECUENCIA DE ESTADOS (se muestran en #statusText, con typing + dots)
    const loadingSteps=[
      "üì® Enviando mensaje al asistente",
      "ü§ñ IASST recibi√≥ tu consulta",
      "üß† Procesando solicitud",
      "üìÇ Revisando documentos",
      "üì° Conectando ideas",
      "‚úçÔ∏è Preparando respuesta"
    ];

    // variables para controlar la animaci√≥n y que NO vuelva a reiniciarse desde 0
    let completed=false;
    let stageIndex=0;
    let lastShownStage=-1;

    while(!completed){
      const statusRes=await fetch(`https://api.openai.com/v1/threads/${currentThreadId}/runs/${runId}`,{
        headers:{
          "Authorization":"Bearer "+API_KEY,
          "OpenAI-Beta":"assistants=v2"
        }
      });
      const st=await statusRes.json();
      console.log(`üîç Estado del run (stageIndex=${stageIndex}):`,st.status);

      if(st.status==="completed"){
        completed=true;
        break;
      } else if(st.status==="failed"){
        clearDots();
        statusText.textContent="‚ö†Ô∏è Error procesando.";
        appendMessage("‚ö†Ô∏è Error procesando.","bot");
        return;
      } else {
        // si a√∫n hay pasos no mostrados, mu√©stralos en orden
        let showStage = (stageIndex < loadingSteps.length) ? stageIndex : loadingSteps.length - 1;

        if(showStage !== lastShownStage){
          // escribir la nueva etapa (efecto m√°quina de escribir)
          await typeStatusText(loadingSteps[showStage]);
          // iniciar animaci√≥n de puntos para indicar que contin√∫a
          startDotAnimation(loadingSteps[showStage]);
          lastShownStage = showStage;
        } else {
          // ya mostramos esta etapa; asegurarnos que haya puntos animando
          if(!dotIntervalId){
            startDotAnimation(loadingSteps[showStage]);
          }
        }

        // avanzamos el index hasta llegar al √∫ltimo, luego se mantiene ah√≠ (no reinicia)
        if(stageIndex < loadingSteps.length) stageIndex++;

        // esperar antes del pr√≥ximo chequeo
        await sleep(1500);
      }
    }

    // limpiar animaciones y mostrar resultado final
    clearDots();
    statusText.textContent="‚úÖ Respuesta recibida.";
    const poll=await fetch(`https://api.openai.com/v1/threads/${currentThreadId}/messages`,{
      headers:{
        "Authorization":"Bearer "+API_KEY,
        "OpenAI-Beta":"assistants=v2"
      }
    });
    const pollData=await poll.json();
    const msg=pollData.data.find(d=>d.role==="assistant"&&d.content?.length>0);
    if(msg) appendMessage(msg.content[0].text.value,"bot");
    console.log("üì• Respuesta recibida:",msg?.content[0]?.text?.value);
  }catch(err){
    clearDots();
    appendMessage("‚ö†Ô∏è Error al comunicar con IASST","bot");
    statusText.textContent="‚ùå Error al comunicar con IASST";
    console.error("‚ùå Error en askAssistant:",err);
  }finally{
    clearDots();
    isWaiting=false;
    input.disabled=false; sendBtn.disabled=false;
    // nota: aqu√≠ dejamos el texto de statusText como 'puedes seguir preguntando' si a√∫n no hubo error
    if(statusText.textContent !== "‚ùå Error al comunicar con IASST") statusText.textContent="üí¨ Puedes seguir preguntando.";
  }
}

// =========================
// EVENTOS CHAT
// =========================
sendBtn.addEventListener('click',()=>{if(input.value.trim()) askAssistant(input.value.trim()),input.value='';});
input.addEventListener('keypress',e=>{if(e.key==="Enter"&&!sendBtn.disabled) sendBtn.click();});

// =========================
// TOGGLE ENTRE MODOS
// =========================
toggle.addEventListener('change',()=>{
  if(toggle.checked){ chatComposer.style.display="flex"; docUploader.style.display="none";}
  else{ chatComposer.style.display="none"; docUploader.style.display="flex";}
});

// =========================
// SUBIR DOCUMENTO CON PROGRESO
// =========================
document.getElementById("uploadBtn").addEventListener("click",()=>{
  const file=document.getElementById("fileInput").files[0];
  if(!file) return alert("Selecciona un documento primero");

  console.log("üìÇ Subiendo documento:",file.name);
  const xhr=new XMLHttpRequest();
  const formData=new FormData();
  formData.append("file",file);
  formData.append("purpose","assistants");

  xhr.open("POST","https://api.openai.com/v1/files");
  xhr.setRequestHeader("Authorization","Bearer "+API_KEY);

  xhr.upload.onprogress=(e)=>{
    if(e.lengthComputable){
      const percent=Math.round((e.loaded/e.total)*100);
      progressBar.style.width=percent+"%";
      statusText.textContent=`üì§ Subiendo... ${percent}%`;
    }
  };

  xhr.onload=()=>{
    if(xhr.status===200){
      progressBar.style.width="100%";
      appendMessage("‚úÖ Documento subido correctamente","bot");
      statusText.textContent="üìÑ Documento listo para consultas.";
      console.log("‚úÖ Documento subido con √©xito");
    }else{
      appendMessage("‚ùå Error al subir documento","bot");
      console.error("‚ùå Error al subir documento:",xhr.responseText);
      statusText.textContent="‚ùå Error al subir documento";
    }
  };

  xhr.send(formData);
});

// subir m√°s documentos
document.getElementById("uploadMore").addEventListener("click",()=>{
  progressBar.style.width="0";
  document.getElementById("fileInput").value="";
  statusText.textContent="‚ûï Puedes subir otro documento o preguntar sin subir.";
});

// preguntar (sin importar si hay doc)
document.getElementById("askDocBtn").addEventListener("click",()=>{
  const q=document.getElementById("docQuestion").value.trim();
  if(!q) return;
  askAssistant(q);
  document.getElementById("docQuestion").value="";
});

// =========================
// START
// =========================
loadFirebaseKeys();
</script>
</body>
</html>
