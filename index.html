<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chat con IASST ‚Äî Ambiente Consultores</title>
  <style>
 :root {
  --deep:#1e2146;
  --accent:#f28a1a;
  --light:#f5f5f7;
  --gray:#bbb;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

body {
  min-height:100vh;
  display:flex;
  align-items:center;
  justify-content:center;
  background:linear-gradient(135deg, var(--deep) 0%, #141630 100%);
  color:#fff;
  padding:20px;
}

.app {
  display:flex;
  flex-direction:column;
  width:100%;
  max-width:1100px;
  background:rgba(30,33,70,0.97);
  border-radius:20px;
  box-shadow:0 12px 40px rgba(0,0,0,0.6);
  overflow:hidden;
}

.header {
  display:flex;
  align-items:center;
  justify-content:space-between;
  flex-wrap:wrap; /* permite que los elementos bajen en pantallas peque√±as */
  gap:10px;
  padding:16px 24px;
}

.header-left {
  display:flex;
  align-items:center;
  gap:12px;
  flex:1; /* ocupa espacio disponible */
  min-width:0; /* evita que empuje demasiado */
}

.header-logo {
  flex-shrink:0;
  width:46px;
  height:46px;
  border-radius:50%;
  overflow:hidden;
  background:#fff;
}
.header-logo img {
  width:100%;
  height:100%;
  object-fit:cover; /* mantiene proporci√≥n circular */
  display:block;
}

/* Textos del header */
.header-title {
  font-size:18px;
  font-weight:bold;
  color:var(--accent);
  white-space:nowrap; /* evita que se rompa raro */
}
.header-sub {
  font-size:12px;
  color:var(--gray);
}

/* Toggle */
.toggle-container{display:flex;align-items:center;gap:10px;color:#fff;font-size:13px;}
.toggle-container input{width:40px;height:20px;}

/* Chat layout */
.chat-area{
  flex:1;
  display:grid;
  grid-template-columns:300px 1fr;
  gap:20px;
  padding:20px;
}

/* Panel izquierda Innovabot */
.side-panel{
  background:rgba(255,255,255,0.05);
  border-radius:16px;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  padding:20px;
  text-align:center;
  box-shadow:0 6px 20px rgba(0,0,0,0.4);
}

.bot-frame{
  width:100%;
  max-width:280px;
  margin:0 auto;
}
.bot-frame img{
  width:100%;
  height:auto;
  display:block;
  object-fit:contain;
}

/* Chat box */
.chat-box{
  display:flex;
  flex-direction:column;
  width:100%;
}

.messages{
  flex:1;
  padding:20px;
  display:flex;
  flex-direction:column;
  gap:12px;
  background:rgba(255,255,255,0.02);
  border-radius:14px;
  max-width:100%;
  max-height:500px;
  overflow-y:auto;
  box-sizing:border-box;
}

.msg{max-width:75%;padding:12px 16px;border-radius:16px;font-size:14px;line-height:1.4;}
.bot{align-self:flex-start;background:rgba(255,255,255,0.1);}
.user{align-self:flex-end;background:linear-gradient(135deg,var(--accent),#ffb165);color:var(--deep);font-weight:500;}

/* Composer */
.composer{
  display:flex;
  gap:10px;
  padding:14px;
  background:rgba(255,255,255,0.05);
}
.composer input{
  flex:1;
  padding:12px;
  border-radius:10px;
  border:none;
  font-size:14px;
  background:rgba(255,255,255,0.1);
  color:#fff;
}
.composer button{
  background:var(--accent);
  border:none;
  color:var(--deep);
  padding:12px 20px;
  border-radius:10px;
  font-weight:bold;
  cursor:pointer;
}

/* Documento */
.doc-uploader{
  display:none;
  flex-direction:column;
  gap:12px;
  padding:14px;
  background:rgba(255,255,255,0.05);
}
.doc-section{display:flex;gap:10px;align-items:center;}
.progress-bar{width:100%;height:14px;background:#333;border-radius:7px;overflow:hidden;}
.progress{height:100%;width:0;background:var(--accent);transition:width 0.3s;}
.doc-controls{display:flex;flex-direction:column;gap:10px;}
.doc-controls input{padding:12px;border-radius:10px;border:none;font-size:14px;background:#fff;color:#000;}
.doc-controls button{background:var(--accent);border:none;color:var(--deep);padding:12px 20px;border-radius:10px;font-weight:bold;cursor:pointer;}
#statusText{padding:8px;text-align:center;font-size:13px;color:#ccc;}

/* --- Mobile --- */
@media(max-width:900px){
  .chat-area{
    grid-template-columns:1fr; /* apila Innovabot arriba y chat abajo */
    gap:15px;
    padding:10px;
  }
  .side-panel{
    width:100%;
    max-width:100%;
    margin:0 auto 10px auto;
  }
  .bot-frame{
    max-width:150px; /* Imagen reducida */
    margin:0 auto;
  }
  .chat-box{
    width:100%;
  }
  .messages{
    max-height:250px;
    padding:12px;
  }
  .composer{
    flex-direction:column;
    gap:8px;
  }
  .composer input,
  .composer button{
    width:100%;
  }
}

/* --- Mobile --- */
@media(max-width:600px){
  .header {
    flex-direction:column;  /* logo arriba, textos abajo */
    align-items:center;
    text-align:center;
  }

  .header-left {
    flex-direction:column;
    gap:6px;
  }

  .header-logo {
    width:60px;  /* un poco m√°s grande en m√≥vil para mantener calidad */
    height:60px;
  }

  .header-title {
    font-size:16px;
  }

  .header-sub {
    font-size:11px;
  }
}

  </style>
</head>
<body>
  <div class="app">
    <div class="header">
      <div class="header-left">
        <div class="header-logo"><img src="AMB.png" alt="Logo"></div>
        <div>
          <div class="header-title">Chat con IASST</div>
          <div class="header-sub">Asistente virtual de Ambiente Consultores</div>
        </div>
      </div>
      <div class="toggle-container">
        <label>Chat Directo</label>
        <input type="checkbox" id="modeToggle" checked />
      </div>
    </div>

    <div class="chat-area">
     <!-- LADO IZQUIERDO Innovabot -->
<div class="side-panel">
  <div class="bot-frame">
     <img id="botImage" src="Resources/Idle/0001.png" alt="Innovabot"> 
  </div>
  <h3>Innovabot</h3>
  <div id="statusText">üîÑ Cargando configuraci√≥n...</div> <!-- üî• MOVIDO AQU√ç -->
</div>

      <!-- LADO DERECHO Chat -->
      <div class="chat-box">
        <div class="messages" id="messages">
          <div class="msg bot">üëã Hola, soy IASST. ¬øEn qu√© te puedo ayudar hoy?</div>
        </div>

        <!-- Input normal -->
        <div class="composer" id="chatComposer">
          <input id="input" placeholder="Escribe tu mensaje..." disabled />
          <button id="send" disabled>Enviar</button>
        </div>

        <!-- Subida de documentos -->
        <div class="doc-uploader" id="docUploader">
          <div class="doc-section">
            <input type="file" id="fileInput" />
            <button id="uploadBtn">Subir Documento</button>
          </div>
          <div class="progress-bar"><div class="progress" id="progress"></div></div>

          <div class="doc-controls" id="docControls">
            <button id="uploadMore">‚ûï Subir otro documento</button>
            <input id="docQuestion" placeholder="Haz una pregunta..." />
            <button id="askDocBtn">Preguntar</button>
          </div>
        </div>

       
      </div>
    </div>
  </div>

<script>
const FIREBASE_URL="https://iasst-b2ab0-default-rtdb.firebaseio.com/.json";
let API_KEY=null,ASSISTANT_ID=null,currentThreadId=null,isWaiting=false;

// refs
const toggle=document.getElementById('modeToggle');
const chatComposer=document.getElementById('chatComposer');
const docUploader=document.getElementById('docUploader');
const progressBar=document.getElementById('progress');
const messages=document.getElementById('messages');
const sendBtn=document.getElementById('send');
const input=document.getElementById('input');
const statusText=document.getElementById('statusText');

// helper para mensajes en pantalla (solo mensajes reales, no debug)
function appendMessage(text,type){
  const div=document.createElement('div');
  div.className='msg '+type;
  div.textContent=text;
  messages.appendChild(div);
  messages.scrollTop=messages.scrollHeight;
}

// =========================
// LOAD CONFIG FROM FIREBASE
// =========================
async function loadFirebaseKeys(){
  try{
    const res=await fetch(FIREBASE_URL);
    const data=await res.json();
    API_KEY=data.KeyChatGPT;
    ASSISTANT_ID=data.KeyAssit;
    statusText.textContent="‚úÖ Configuraci√≥n lista. Pregunta lo que quieras.";
   PlayAnimation("Idle", 12, 1, 22);
    input.disabled=false; sendBtn.disabled=false;
    console.log("‚öôÔ∏è Configuraci√≥n cargada:",data);
  }catch(e){
    statusText.textContent="‚ùå Error al cargar configuraci√≥n";
    console.error("‚ùå Error al cargar Firebase:",e);
  }
}

// =========================
// THREAD
// =========================
async function createThread(){
  console.log("üßµ Creando nuevo thread...");
  const res=await fetch("https://api.openai.com/v1/threads",{
    method:"POST",
    headers:{
      "Authorization":"Bearer "+API_KEY,
      "Content-Type":"application/json",
      "OpenAI-Beta":"assistants=v2"
    },
    body:"{}"
  });
  const data=await res.json();
  currentThreadId=data.id;
  console.log("‚úÖ Thread creado:",currentThreadId);
}

// =========================
// ASK ASSISTANT (GENERAL)
// =========================
async function askAssistant(question){
  // helpers locales para animaciones/tiempos
  if(!currentThreadId) await createThread();
  function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
  let dotIntervalId = null;
  function clearDots(){ if(dotIntervalId){ clearInterval(dotIntervalId); dotIntervalId=null; } }

  async function typeStatusText(text, speed=20){
    // Si el texto actual es exactamente igual, no volver a teclear
    if(statusText._lastTyped === text) return;
    clearDots();
    statusText._lastTyped = text;
    statusText.textContent = "";
    for(let i=0;i<=text.length;i++){
      statusText.textContent = text.slice(0,i);
      await sleep(speed);
    }
  }

  
// obtener TODOS los archivos antes de enviar mensaje
const filesRes = await fetch("https://api.openai.com/v1/files", {
  headers: { "Authorization": "Bearer " + API_KEY }
});
const filesData = await filesRes.json();
const allFileIds = filesData.data.map(f => f.id);

  function startDotAnimation(baseText, interval=500){
    clearDots();
    let dots = "";
    dotIntervalId = setInterval(()=>{
      dots = (dots.length >= 3) ? "" : dots + ".";
      statusText.textContent = baseText + dots;
    }, interval);
  }

  try{
    if(!currentThreadId) await createThread();
    isWaiting=true;
    input.disabled=true; sendBtn.disabled=true;
    statusText.textContent="‚è≥ Preguntando a IASST...";
    appendMessage(question,'user');
    console.log("üì§ Enviando pregunta:",question);

// enviar mensaje al thread
const msgRes = await fetch(`https://api.openai.com/v1/threads/${currentThreadId}/messages`, {
  method:"POST",
  headers:{
    "Authorization":"Bearer "+API_KEY,
    "Content-Type":"application/json",
    "OpenAI-Beta":"assistants=v2"
  },
  body: JSON.stringify({
    role:"user",
    content:[{type:"text", text:question}]
    // ‚úÖ sin attachments, porque los docs ya est√°n vinculados al Assistant
  })
});

// ‚ö†Ô∏è Verificar si hubo error
if(!msgRes.ok){
  const errData = await msgRes.json();
  console.error("‚ùå Error al enviar mensaje:", errData);
  appendMessage("‚ö†Ô∏è Error enviando el mensaje.","bot");
  statusText.textContent = "‚ùå Error enviando el mensaje";
  return;
}
PlayAnimation("Thinking", 12, 16, 29);

console.log("‚úÖ Mensaje enviado al thread");
const runRes = await fetch(`https://api.openai.com/v1/threads/${currentThreadId}/runs`, {
  method:"POST",
  headers:{
    "Authorization":"Bearer "+API_KEY,
    "Content-Type":"application/json",
    "OpenAI-Beta":"assistants=v2"
  },
  body: JSON.stringify({ assistant_id: ASSISTANT_ID })
});

if (!runRes.ok) {
  const errData = await runRes.json();
  console.error("‚ùå Error lanzando run:", errData);
  appendMessage("‚ö†Ô∏è Error al lanzar la consulta.","bot");
  statusText.textContent = "‚ùå No se pudo procesar la pregunta.";
  return; // üëà detener aqu√≠ para no seguir con runId undefined
}

const runData = await runRes.json();
const runId = runData.id;
console.log("üöÄ Run lanzado:", runId, runData);


    // SECUENCIA DE ESTADOS (se muestran en #statusText, con typing + dots)
    const loadingSteps=[
      "üì® Enviando mensaje al asistente",
      "ü§ñ IASST recibi√≥ tu consulta",
      "üß† Procesando solicitud",
      "üìÇ Revisando documentos",
      "üì° Conectando ideas",
      "‚úçÔ∏è Preparando respuesta"
    ];

    // variables para controlar la animaci√≥n y que NO vuelva a reiniciarse desde 0
    let completed=false;
    let stageIndex=0;
    let lastShownStage=-1;

    while(!completed){
      const statusRes=await fetch(`https://api.openai.com/v1/threads/${currentThreadId}/runs/${runId}`,{
        headers:{
          "Authorization":"Bearer "+API_KEY,
          "OpenAI-Beta":"assistants=v2"
        }
      });
      const st=await statusRes.json();
      console.log(`üîç Estado del run (stageIndex=${stageIndex}):`,st.status);

      if(st.status==="completed"){
        completed=true;
        break;
      } else if(st.status==="failed"){
        clearDots();
        statusText.textContent="‚ö†Ô∏è Error procesando.";
        appendMessage("‚ö†Ô∏è Error procesando.","bot");
        return;
      } else {
        // si a√∫n hay pasos no mostrados, mu√©stralos en orden
        let showStage = (stageIndex < loadingSteps.length) ? stageIndex : loadingSteps.length - 1;

        if(showStage !== lastShownStage){
          // escribir la nueva etapa (efecto m√°quina de escribir)
          await typeStatusText(loadingSteps[showStage]);
          // iniciar animaci√≥n de puntos para indicar que contin√∫a
          startDotAnimation(loadingSteps[showStage]);
          lastShownStage = showStage;
        } else {
          // ya mostramos esta etapa; asegurarnos que haya puntos animando
          if(!dotIntervalId){
            startDotAnimation(loadingSteps[showStage]);
          }
        }

        // avanzamos el index hasta llegar al √∫ltimo, luego se mantiene ah√≠ (no reinicia)
        if(stageIndex < loadingSteps.length) stageIndex++;

        // esperar antes del pr√≥ximo chequeo
        await sleep(1500);
      }
    }

    // limpiar animaciones y mostrar resultado final
    clearDots();
    statusText.textContent="‚úÖ Respuesta recibida.";
    const poll=await fetch(`https://api.openai.com/v1/threads/${currentThreadId}/messages`,{
      headers:{
        "Authorization":"Bearer "+API_KEY,
        "OpenAI-Beta":"assistants=v2"
      }
    });
    const pollData=await poll.json();
    const msg=pollData.data.find(d=>d.role==="assistant"&&d.content?.length>0);
    if(msg) appendMessage(msg.content[0].text.value,"bot");
PlayAnimation("Speak", 12, 25, 44);

    console.log("üì• Respuesta recibida:",msg?.content[0]?.text?.value);
  }catch(err){
    clearDots();
    appendMessage("‚ö†Ô∏è Error al comunicar con IASST","bot");
    statusText.textContent="‚ùå Error al comunicar con IASST";
    console.error("‚ùå Error en askAssistant:",err);
  }finally{
    clearDots();
    isWaiting=false;
    input.disabled=false; sendBtn.disabled=false;
    // nota: aqu√≠ dejamos el texto de statusText como 'puedes seguir preguntando' si a√∫n no hubo error
    if(statusText.textContent !== "‚ùå Error al comunicar con IASST") statusText.textContent="üí¨ Puedes seguir preguntando.";
     setTimeout(()=>{
      PlayAnimation("Idle", 12, 1, 22);
    }, 5000);
  }
}

// =========================
// EVENTOS CHAT
// =========================
sendBtn.addEventListener('click',()=>{if(input.value.trim()) askAssistant(input.value.trim()),input.value='';});
input.addEventListener('keypress',e=>{if(e.key==="Enter"&&!sendBtn.disabled) sendBtn.click();});

// =========================
// TOGGLE ENTRE MODOS
// =========================
toggle.addEventListener('change',()=>{
  if(toggle.checked){ chatComposer.style.display="flex"; docUploader.style.display="none";}
  else{ chatComposer.style.display="none"; docUploader.style.display="flex";}
});



// subir m√°s documentos
document.getElementById("uploadMore").addEventListener("click",()=>{
  progressBar.style.width="0";
  document.getElementById("fileInput").value="";
  statusText.textContent="‚ûï Puedes subir otro documento o preguntar sin subir.";
});

// preguntar (sin importar si hay doc)
document.getElementById("askDocBtn").addEventListener("click",()=>{
  const q=document.getElementById("docQuestion").value.trim();
  if(!q) return;
  askAssistant(q);
  document.getElementById("docQuestion").value="";
});

// =========================
// SUBIR DOCUMENTO Y VINCULARLO AL ASSISTANT
// =========================
const VECTOR_STORE_ID = "vs_12345"; // ‚ö†Ô∏è Reempl√°zalo por el ID real de tu vector store

document.getElementById("uploadBtn").addEventListener("click", async () => {
  const file = document.getElementById("fileInput").files[0];
  if (!file) return alert("Selecciona un documento primero");

  try {
    console.log("üìÇ Subiendo documento:", file.name);
    statusText.textContent = "üì§ Subiendo documento...";

    // 1Ô∏è‚É£ Subir archivo
    const formData = new FormData();
    formData.append("file", file);
    formData.append("purpose", "assistants");

    const uploadRes = await fetch("https://api.openai.com/v1/files", {
      method: "POST",
      headers: { "Authorization": "Bearer " + API_KEY },
      body: formData
    });

    if (!uploadRes.ok) {
      throw new Error("‚ùå Error al subir archivo: " + (await uploadRes.text()));
    }

    const fileData = await uploadRes.json();
    console.log("‚úÖ Archivo subido:", fileData);
    const fileId = fileData.id;

    const VECTOR_STORE_ID = "vs_68c833a4720081919ee584a15e1ccdff"; // üëà tu ID real entre comillas

 // 2Ô∏è‚É£ Asociar archivo al Vector Store
const assocRes = await fetch(
  `https://api.openai.com/v1/vector_stores/${VECTOR_STORE_ID}/files`,
  {
    method: "POST",
    headers: { 
      "Authorization": "Bearer " + API_KEY,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ file_id: fileId }) // üëà importante: JSON, no form-urlencoded
  }
);

    if (!assocRes.ok) {
      throw new Error("‚ùå Error al asociar archivo al vector store: " + (await assocRes.text()));
    }

    const assocData = await assocRes.json();
    console.log("‚úÖ Archivo agregado al Vector Store:", assocData);

    // 3Ô∏è‚É£ Feedback visual
    progressBar.style.width = "100%";
    appendMessage("‚úÖ Documento subido y agregado al asistente correctamente", "bot");
    statusText.textContent = "üìÑ Documento listo para consultas.";

  } catch (err) {
    console.error(err);
    appendMessage("‚ùå Error al procesar el documento", "bot");
    statusText.textContent = "‚ùå Error al subir documento";
  }
});


// =========================
// START
// =========================
let animInterval = null;


function PlayAnimation(animName, fps=30, startFrame=1, endFrame=90){
  const imgElement = document.getElementById("botImage");
  if(!imgElement) return;

  if(animInterval){ clearInterval(animInterval); animInterval=null; }

  const folder = `Resources/${animName}/`;
  const frames = [];

  for(let i=startFrame; i<=endFrame; i++){
    const frameNum = String(i).padStart(4, "0"); // ‚Üí 0001, 0025, etc.
    const img = new Image();
    img.src = `${folder}${frameNum}.png`;
    frames.push(img);
  }

  let index=0;
  frames[0].onload = ()=>{
    imgElement.src = frames[0].src;
    animInterval = setInterval(()=>{
      index = (index+1) % frames.length;
      imgElement.src = frames[index].src;
    }, 500/fps);
  };
}

loadFirebaseKeys();
</script>
</body>
</html>
